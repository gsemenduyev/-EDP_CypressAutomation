pipeline {
    agent {
        docker {
            label 'al2'
            image 'cypress/browsers:node18.12.0-chrome107'
            args '--ipc=host'
    }
}
    parameters{
        choice(name: 'ENVIRONMENT', choices: ['Production', 'QA'], description: "Choice the Environment to run")
        choice(name: 'POJECTS', choices: ['Stratasphere', 'ARFP', 'WIP'], description: "Choice the Project to run")
    }
    options{
        ansiColor('xterm')
    }
    stages {
        stage('Test') {
            steps {
            sh "cd E2E/ARFP-Stratasphere && npm cache clean --force && npm ci --prefer-offline && npx cypress run --browser chrome --env tags=\"@${POJECTS}\",ENV=\"@${ENVIRONMENT}\""
            }
        }
    }
    post{
        always{
            script {
                sh "cd E2E/ARFP-Stratasphere && node ./cucumber-html-report.js"
            }
      publishHTML (target : [allowMissing: true,
        alwaysLinkToLastBuild: true,
        keepAll: true,
        reportDir: 'E2E/ARFP-Stratasphere/cypress/reports',
        reportFiles: 'cucumber-reports/cucumber-html-report/index.html',
        reportName: 'Cucumber Report',
        reportTitles: 'Cucumber Report'])
      publishHTML (target : [allowMissing: true,
        alwaysLinkToLastBuild: true,
        keepAll: true,
        reportDir: 'E2E/ARFP-Stratasphere/cypress/reports',
        reportFiles: 'multi-html-report/index.html',
        reportName: 'Multi HTML Report',
        reportTitles: 'Multi HTML Report'])
        }
    }
}